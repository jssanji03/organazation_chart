const options = 
{
   "id":"200066",
            "level":1,
            "className":"level1",
            "dept":"總經理室",
            "position":"總經理",
            "name":"maggie",
            "chName":"OOO",
            "ext":"5011",
            "area":"新店9樓",
            "areaUrl":"新店9樓",
            "pic":"https://fakeimg.pl/100x100/DDDDDD/",
            "count":null,
            "teamDetail":"",
            "isLast":false,
            "children":[
               {
                  "id":"200066",
                  "level":2,
                  "className":"level2",
                  "dept":"市場行銷處",
                  "position":"總經理",
                  "name":"maggie.chao",
                  "chName":"OOO",
                  "ext":"5011",
                  "area":"新店9樓",
                  "areaUrl":null,
                  "pic":null,
                  "count":null,
                  "teamDetail":"跟隨公司擬定之經營策略，爭取外部市場發展之最大可能：\r\n​- 負責業務策略及相關業務系統之整合及推動\r\n- 驅動並持續發展公司定義之聚焦市場\r\n- 依據公司業務發展及獲利目標，訂定產品及技術提升之策略方向​\r\n- 透過市場調查及客戶研究，瞭解客戶需求，以發展公司年度行銷策略\r\n- 維護客戶關係管理、客戶資料分析，規劃與執行行銷活動",
                  "isLast":false,
                  "children":[
                     {
                        "id":"200071",
                        "level":3,
                        "className":"level3",
                        "dept":"通路事業部",
                        "position":"經理",
                        "name":"david.hsiao",
                        "chName":"OOO",
                        "ext":"5012",
                        "area":"新店9樓",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"強化通路價值，實現業務開發：\r\n依公司定義聚焦之應用市場及產品組合，研擬轄下各地區銷售策略，穩固既有通路夥伴 (Customer Intimacy)，持續開發Solution Provider，培養關鍵客戶Key Account。持續發掘目標客戶的JTBD (Jobs to Be Done)，提供我們最佳的產品及服務以創造營收。同時，藉由不斷累積及厚實的客戶群，提高益網品牌在該目標市場的市佔率。",
                        "isLast":false,
                        "children": [
                            {
                            "id":"200071",
                            "level":3,
                            "className":"isLast",
                            "dept":"課務一",
                            "position":"經理",
                            "name":"david.hsiao",
                            "chName":"OOO",
                            "ext":"5012",
                            "area":"nullnull",
                            "areaUrl":null,
                            "pic":null,
                            "count":null,
                            "teamDetail":"強化通路價值，實現業務開發：\r\n依公司定義聚焦之應用市場及產品組  合，研擬轄下各地區銷售策略，穩固既有通路夥伴 (Customer Intimacy)，持續開發    Solution Provider，培養關鍵客戶Key Account。持續發掘目標客戶的JTBD (Jobs to     Be Done)，提供我們最佳的產品及服務以創造營收。同時，藉由不斷累積及厚實的客戶群，提  高益網品牌在該目標市場的市佔率。",
                            "isLast":true,
                            "children":[
                            ]
                            },
                            {
                            "id":"200071",
                            "level":3,
                            "className":"isLast",
                            "dept":"課務一",
                            "position":"經理",
                            "name":"david.hsiao",
                            "chName":"OOO",
                            "ext":"5012",
                            "area":"nullnull",
                            "areaUrl":null,
                            "pic":null,
                            "count":null,
                            "teamDetail":"強化通路價值，實現業務開發：\r\n依公司定義聚焦之應用市場及產品組  合，研擬轄下各地區銷售策略，穩固既有通路夥伴 (Customer Intimacy)，持續開發    Solution Provider，培養關鍵客戶Key Account。持續發掘目標客戶的JTBD (Jobs to     Be Done)，提供我們最佳的產品及服務以創造營收。同時，藉由不斷累積及厚實的客戶群，提  高益網品牌在該目標市場的市佔率。",
                            "isLast":true,
                            "children":[
                            ]
                            },
                           
                        ]
                     },
                     {
                        "id":"200073",
                        "level":3,
                        "className":"isLast",
                        "dept":"業務管理部",
                        "position":"副理",
                        "name":"annie.fan",
                        "chName":"OOO",
                        "ext":"5024",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"業務營運基礎建設推手：\r\n- 集團業務支援及維護客戶關係管理。\r\n- 提供完善的後勤支援管理系統，有效縮短公司內部作業流程並提高執行效率。\r\n- 依照各項業務經營目的協助有效的規範、調整管理活動，及協助推動決策執行。 \r\n- 依照營運績效追蹤分析提供例行性管理性分析報表。",
                        "isLast":true,
                        "children":[
                           
                        ]
                     },
                     {
                        "id":"200072",
                        "level":3,
                        "className":"isLast",
                        "dept":"行銷企劃部",
                        "position":"副理",
                        "name":"sunny.cheng",
                        "chName":"OOO",
                        "ext":"5084",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"以多元活動形式，傳遞益網自有品牌之產品與服務價值於聚焦市場之中：\r\n- 針對公司的企業形象與品牌價值，規劃並執行各類行銷推廣活動/策略。\r\n- 跨部門合作，完成專案計畫，由內而外完善企業識別/品牌價值。\r\n- 經營暨維護網路數位平台。",
                        "isLast":true,
                        "children":[
                           
                        ]
                     },
                     {
                        "id":"200222",
                        "level":3,
                        "className":"isLast",
                        "dept":"產品應用暨技術諮詢部",
                        "position":"副理",
                        "name":"louis.chen",
                        "chName":"OOO",
                        "ext":"5118",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"以售前諮詢及售後服務，橋接合作產品、客戶與內部技術團隊：\r\n- 協助專案客戶進行網路拓譜建置諮詢及產品應用規劃\r\n- 提供設備異常原因判斷及故障排除服務\r\n- 以客戶經驗回饋，協作強化產品價值",
                        "isLast":true,
                        "children":[
                           
                        ]
                     },
                     {
                        "id":"200342",
                        "level":3,
                        "className":"isLast",
                        "dept":"工業乙太網路產品行銷部",
                        "position":"資深經理",
                        "name":"ben.chiang",
                        "chName":"OOO",
                        "ext":"5208",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"益網自有品牌有線產品及聚焦市場發展之先驅：\r\n- 於核心發展之聚焦市場中，強化內部資源整合，經營品牌發展策略。\r\n- 擬定工業乙太網路設備之應用及技術發展的中長期策略方向，含有關技術授權、技術外購和策略聯盟的評估。\r\n- 統籌新產品之行銷策略，並對新產品營收及獲利負責。",
                        "isLast":true,
                        "children":[
                           
                        ]
                     },
                     {
                        "id":"200111",
                        "level":3,
                        "className":"isLast",
                        "dept":"策略市場部",
                        "position":"經理",
                        "name":"david.fan",
                        "chName":"OOO",
                        "ext":"5202",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"深耕於特定應用，實現業務開發：\r\n依公司定義聚焦之特定垂直市場及產品組合,  觀察及了解該市場應用及專業需求, 發掘潛在的商業機會. 選定最有機會且具成長動能的關鍵客戶, 擬定最適宜的開發策略. 以關鍵客戶需求為出發點, 發掘其JTBD (Jobs to Be Done), 同時連結益網技術諮詢團隊, 快速提出完整解決方案。",
                        "isLast":true,
                        "children":[
                           
                        ]
                     },
                     {
                        "id":"200241",
                        "level":3,
                        "className":"isLast",
                        "dept":"無線物聯網創新部",
                        "position":"經理",
                        "name":"joseph.cheng",
                        "chName":"OOO",
                        "ext":"5127",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"無線產品線之規劃與管理",
                        "isLast":true,
                        "children":[
                           
                        ]
                     }
                  ]
               },
               {
                  "id":"200318",
                  "level":2,
                  "className":"level2",
                  "dept":"人力暨資訊資源服務部",
                  "position":"資深經理",
                  "name":"vicky.huang",
                  "chName":"OOO",
                  "ext":"5166",
                  "area":"nullnull",
                  "areaUrl":null,
                  "pic":null,
                  "count":null,
                  "teamDetail":"人力資源：以功能面區分：人事行政、人力資源管理、人力資源發展、人力資本管理\r\n- 研究如何找到「對」的人加入團隊、如何提升員工的學習成效、如何確保員工對團隊力的承諾，\r\n- 員工為企業最重要的投資標的，認知到每個人的獨特性。所以著重在組織跟個人的價值觀契合度。\r\n\r\n資訊服務：以功能面區分：管理監控分析、軟硬維護執行、有效整合設計\r\n- 在IT服務上維持可靠、安全、高效且具成本效益的基本營運。\r\n- 了解企業管理階層與董事會目標，科學方法分析可行的科技解決方案。\r\n- 重新衡量IT支出的分配，逐漸轉向符合未來目標的發展項目。",
                  "isLast":false,
                  "children":[
                     
                  ]
               },
               {
                  "id":"200207",
                  "level":2,
                  "className":"level2",
                  "dept":"行政處",
                  "position":"經理",
                  "name":"charles.liu",
                  "chName":"OOO",
                  "ext":"5081",
                  "area":"nullnull",
                  "areaUrl":null,
                  "pic":null,
                  "count":null,
                  "teamDetail":"以「維持公司營運順暢，保障同仁安全及健康」為使命，並以「團隊相互合作，創造共享價值」為願景。",
                  "isLast":false,
                  "children":[
                     {
                        "id":"200207",
                        "level":3,
                        "className":"isLast",
                        "dept":"總務部",
                        "position":"經理",
                        "name":"charles.liu",
                        "chName":"OOO",
                        "ext":"5081",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"- 總務事務與環境維護之管理\r\n- 辦公室租賃及修繕管理\r\n- 安衛環管理系統之協辦與執行",
                        "isLast":true,
                        "children":[
                           
                        ]
                     },
                     {
                        "id":"200207",
                        "level":3,
                        "className":"isLast",
                        "dept":"財會部",
                        "position":"經理",
                        "name":"charles.liu",
                        "chName":"OOO",
                        "ext":"5081",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"- 統籌公司帳務處理、執行成本資料蒐集與分析。\r\n- 規畫暨執行公司財務管理及資金調度業務。\r\n- 財務報表之編制及管理性財務資料之建立與分析。\r\n- 綜合管理公司稅務之規劃、執行及各項稅務法令之遵循。\r\n- 預算規劃及控管每月預算執行狀況及差異分析。",
                        "isLast":true,
                        "children":[
                           
                        ]
                     }
                  ]
               },
               {
                  "id":"200022",
                  "level":2,
                  "className":"level2",
                  "dept":"供應鏈管理處",
                  "position":"經理",
                  "name":"christina.chen",
                  "chName":"OOO",
                  "ext":"6300",
                  "area":"nullnull",
                  "areaUrl":null,
                  "pic":null,
                  "count":null,
                  "teamDetail":"整合供應商、客戶與市場供需資訊，規劃生產與安排出貨交期。",
                  "isLast":false,
                  "children":[
                     {
                        "id":"200022",
                        "level":3,
                        "className":"isLast",
                        "dept":"製造部",
                        "position":"經理",
                        "name":"christina.chen",
                        "chName":"OOO",
                        "ext":"6300",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"- 綜理產品之生產執行並準時完成工單以符合預定交期。\r\n- 處理量產後的產品生產過程品質異常問題。\r\n- 協調研發人員進行產品開發時期試產事宜。\r\n- 持續進行提高良率與降低成本，改善製程之精進事項。",
                        "isLast":true,
                        "children":[
                           
                        ]
                     },
                     {
                        "id":"200022",
                        "level":3,
                        "className":"isLast",
                        "dept":"資材部",
                        "position":"經理",
                        "name":"christina.chen",
                        "chName":"OOO",
                        "ext":"6300",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"- 依據接單需求，規劃最佳化生產計劃與排程後，安排工單生產製令。  \r\n- 確認物料狀況，確保如期生產，以符合客戶交期。  \r\n- 擬定量產條件之修正與最適化策略，跟催物料協調產線作業，以達到生產作業順暢。  \r\n- 協調外包廠完成SMT代工與部分全製程生產項目，包含協調料件調度相關事宜。\r\n- 協助開發團隊處理新料件與替代料件之選用事宜。\r\n- 規畫選商策略與負責新供應商承認與廠驗檢核事宜\r\n- 評析原物料市場供應資訊及成本控制，根據需求執行採購作業以及料況追蹤處理，直至驗收入庫請款流程完畢 。\r\n- 物料收發、半成品、成品之入庫、保管、盤存以及出貨運輸安排。",
                        "isLast":true,
                        "children":[
                           
                        ]
                     }
                  ]
               },
               {
                  "id":"200084",
                  "level":2,
                  "className":"level2",
                  "dept":"品質保證處",
                  "position":"資深經理",
                  "name":"wayne.chen",
                  "chName":"OOO",
                  "ext":"6200",
                  "area":"nullnull",
                  "areaUrl":null,
                  "pic":null,
                  "count":null,
                  "teamDetail":"推行品質管理系統及推動持續改善，確保生產高品質的產品，並提供客戶優良且快速的服務。配合各單位需求，提供品質相關事項的服務，以推動公司持續成長。",
                  "isLast":false,
                  "children":[
                     {
                        "id":"200084",
                        "level":3,
                        "className":"isLast",
                        "dept":"品質系統部",
                        "position":"資深經理",
                        "name":"wayne.chen",
                        "chName":"OOO",
                        "ext":"6200",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"- 管理系統的運作與監督: 建立並推行公司整體國際管理系統之運作，公司內外稽核計劃之擬定與執行，作業流程改善專案溝通協調與執行。\r\n- 文管中心: 產品BOM資訊維護與管理，產品設計(NPDP)資料維護與管理。\r\n- 綠色產品: 產品符合有害物質規範的推行。 ",
                        "isLast":true,
                        "children":[
                           
                        ]
                     },
                     {
                        "id":"200084",
                        "level":3,
                        "className":"isLast",
                        "dept":"品質保證部",
                        "position":"資深經理",
                        "name":"wayne.chen",
                        "chName":"OOO",
                        "ext":"6200",
                        "area":"nullnull",
                        "areaUrl":null,
                        "pic":null,
                        "count":null,
                        "teamDetail":"- 品質保證: 產品品質管理與監督。\r\n- 持續改善: 品質持續改善的推動。\r\n- 售後服務: 快速且完善的售後服務與客訴回應。",
                        "isLast":true,
                        "children":[
                           
                        ]
                     }
                  ]
               }
            ]
}

function nodeTemplate(options) {
   let areaControl = '';
   let departmentIcon = '';
   // let bottomPanel = '';
   let level3 = '';
   let level2 = '';
   let level1 = '';
   let isLast = '';

    if (options.areaUrl !== null) {
        areaControl = `<div class="areaUrl" data-url="${options.areaUrl}" data-bs-toggle="modal" data-bs-target="#floorPlan">${options.area}<i class="fas fa-angle-right"></i></div>`;
    } else {
        areaControl = options.area;
    }
    if (!options.isLast) {
        departmentIcon = `<span class="col-2 icon" data-bs-toggle="modal" data-bs-target="#exampleModal${options.id}"><i class="far fa-id-card"></i></span>`;
    }
   
   if (options.className == "level1" || options.className == "level2") {
      level1 = `
            <div class="col-lg-3 col-12">
               <div class="pic">
                  <img src="https://fakeimg.pl/100x100/DDDDDD/">
               </div>
            </div>
            <div class="col-lg-9 col-12">
               <div class="row m-1 align-items-center">
                  <div class="col-12 titleHeader">
                     <p class="position">${options.position}</p>
                     <p class="name">${options.chName}</p>
                     <p class="name">${options.name}</p>
                  </div>
               </div>
            </div>
            <div class="col-12">
               <div class="row align-items-center">
                  <div class="col-6 text-start">
                     <p>分機<span>${options.ext}</span></p>
                  </div>
               <div class="col-6">
                  <div class="areaUrl" data-url="${options.areaUrl}" data-bs-toggle="modal" data-bs-target="#floorPlan">${options.area}</div>
               </div>
            </div>
      `
   }
   else if (options.className == "level3") {
      level3 = `
            <div class="col-lg-12">
               <div class="row m-1">
                  <div class="col-12 titleHeader p-0">
                     <p class="position">${options.position}</p>
                     <p class="name">${options.chName} &nbsp;  <span class="name">${options.name}</span></p> 
                  </div>
                  <div class="col-12">
                     <div class="row justify-content-between py-1">
                        <div class="col-6 p-0 text-start">
                           <p>分機<span>${options.ext}</span></p>
                        </div>
                        <div class="col-6 p-0">
                           <p>${areaControl}</p>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
      `
   }
   else if (options.isLast) {
      isLast = `
            <div class="col-12">
               <div class="row m-1">
                  <div class="col-12 titleHeader p-0">
                     <p class="position">${options.position}</p>
                     <p class="name">${options.chName} &nbsp; <span class="name">${options.name}</span></p>
                      
                  </div>
                  <div class="col-12">
                     <div class="row text-start">
                        <div class="col-6 p-0">
                           <p>分機<span>${options.ext}</span></p>
                        </div>
                        <div class="col-6 p-0">
                           <p>${areaControl}</p>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
      `
   }
    return `
        <div class="header d-flex">
            <span class="col-10 dept">${options.dept}</span>
            ${departmentIcon}
        </div>
        <div class="d-flex flex-wrap align-items-center text-center p-0">
            ${level1}
            ${level2}
            ${level3}
            ${isLast}
        </div>
        `;
}
const orgRender = $("#chart-container").orgchart({
   data: options,
   nodeTemplate: nodeTemplate,
   nodeContent: "name",
   verticalLevel: 3,
   visibleLevel: 2,
   depth: 2,
   toggleSiblingsResp: false,
   initCompleted: scrollbarOffset,   
   'createNode': function($node, options) {
      const Area = $('.modalArea')
      const detailContent = `
      <div class="modal fade" id="exampleModal${options.id}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">${options.dept}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            ${options.teamDetail}
                        </div>
                        </div>
                    </div>
         </div>  
      `;
        $(detailContent).appendTo(Area);
   },
});

function getWindowSize() {
   const windowWidth = window.innerWidth;
   const windowHeight = window.innerHeight;
   console.log('windowWidth',windowWidth);
   console.log('windowHeight',windowHeight);
   if (windowWidth <= 991) {
      orgRender.options.verticalLevel = 2
      // console.log(orgRender.options.verticalLevel);
   } else {
      orgRender.options.verticalLevel = 3
      // console.log(orgRender.options.verticalLevel);
      // return 3
   }
}
getWindowSize()

document.querySelector(".js-toggle").addEventListener("click",showAll)

function showAll() {
    let $temp = orgRender.$chart.find('.nodes');
    if ($temp.hasClass('hidden') || $temp.children("li").hasClass('hidden')) {
         $temp[0].offsetWidth;
         $temp.removeClass('hidden');
         $temp.find('.isCollapsedDescendant').removeClass('isCollapsedDescendant');
         $temp.find('.isCollapsedSibling').removeClass('isCollapsedSibling');
         $temp.find('.slide-up').removeClass('slide-up');
         $temp.find('.slide-right').removeClass('slide-right');
         $temp.children("li").removeClass('hidden');
         $temp.children("li").find('.isCollapsedSibling').removeClass('isCollapsedSibling');
         $temp.children("li").find('.slide-up').removeClass('slide-up');
         $temp.children("li").find('.slide-right').removeClass('slide-right');
         $temp.children("li").find('.slide-left').removeClass('slide-left');
       scrollbarOffset()
      //  scaleRender ()
   } 
     else {
      orgRender.hideChildren(orgRender.$chart.find('.level2'));
       scrollbarOffset()
      //  scaleRender ()
   }
}

function scrollbarOffset($node, options) {
   const $container = orgRender.$chartContainer;
   const $chart = orgRender.$chart;
   const screenWidth = $(window).width();
   const obj = $(".orgchart").width()
   const objLeft = obj-screenWidth;
   $(window).scrollLeft(objLeft)
   // scaleRender () 
   console.log(document.querySelector(".orgchart").offsetTop);
   console.log(document.querySelector("#chart-container").offsetTop);
}


function scaleRender () {
      const $container = orgRender.$chartContainer;
      const $chart = orgRender.$chart;
      const scale = $container.width() / $chart.outerWidth(true);
      const x = ($container.width() - $chart.outerWidth(true))/2*(1/scale);
      const y = ($container.height() - $chart.outerHeight(true))/2*(1*scale);
      orgRender.setChartScale($chart, scale);
      let val = $chart.css('transform');
   $chart.css('transform', val + ' translate(' + x + 'px,' + y + 'px)');
   console.log('$container',$container.height());
   console.log('$chart',$chart.outerHeight(true));
 }
scaleRender () 
